# Scintilla & Lexilla Upgrade Plan

## Current vs Latest Versions

| Library | Current | Latest | Gap |
|---------|---------|--------|-----|
| Scintilla | 5.5.7 | **5.5.8** | 1 minor |
| Lexilla | 5.4.5 | **5.4.6** | 1 minor |

## Customization Analysis

### Lexilla: üî¥ HAS CUSTOMIZATIONS (lexers_x/)

The `lexilla/lexers_x/` folder contains **24 custom files** that MUST be preserved:

| File | Type | Notes |
|------|------|-------|
| `LexAHK.cxx` | Custom Lexer | AutoHotkey |
| `LexCSV.cxx` | Custom Lexer | CSV/TSV |
| `LexJSON.cxx` | **Modified** | Enhanced version (orig in `orig/`) |
| `LexKotlin.cxx` | **Modified** | Enhanced version (orig from zufuliu) |
| `LexVerilog.cxx` | **Modified** | Enhanced version (orig in `orig/`) |
| `LexerUtils.cxx/h` | Helper | Shared lexer utilities |
| `CharSetX.h` | Helper | Extended character sets |
| `StringUtils.h` | Helper | String utilities |
| `SciX.iface` | Extension | Extended Scintilla interface |
| `SciXLexer.h` | Extension | Extended lexer header |
| `homebrew/LexAHK*.cxx` | Homebrew | Alternative AHK implementations |
| `orig/*.cxx` | Backups | Original upstream versions |

**CRITICAL**: The `lexers/` folder (41 files) may also have modifications - these are Lexilla's standard lexers.

### Scintilla: üî¥ HAS CUSTOMIZATIONS (oniguruma/)

| Customization | Files | Impact |
|---------------|-------|--------|
| **Oniguruma Regex Engine** | `oniguruma/scintilla/OnigurumaRegExEngine.cxx` (~904 lines) | Must preserve |
| **Oniguruma Library** | `oniguruma/src/` (40+ files) | Must preserve |
| **Custom VS Projects** | `Scintilla.vcxproj`, `ScintillaDLL.vcxproj` | May need merge |
| **NP3 Compiler Defines** | `SCI_OWNREGEX`, `NP3`, `ONIG_STATIC`, `NO_CXX11_REGEX` | Must keep |

---

## Scintilla.h NP3 Patches (CRITICAL)

The `scintilla/include/Scintilla.h` file has **extensive NP3 customizations** that must be merged into any new upstream version. These patches enable DLL binding and add NP3-specific features.

### Patch 1: DLL Export Functions (Lines 18-30)

**Added before `#ifdef __cplusplus`:**

```c
// >>>>>>>>>>>>>>>>   BEG NON STD SCI PATCH   >>>>>>>>>>>>>>>>
// ==============================================================
// --- needed to bind Scintilla as dynamic link library (DLL) ---
// ==============================================================
typedef struct _wrct_t { long left; long top; long right; long bottom; } WRECT, *LPWRECT;
__declspec(dllexport) int       Scintilla_RegisterClasses(void *hInstance);
__declspec(dllexport) int       Scintilla_ReleaseResources(void);
__declspec(dllexport) int       Scintilla_InputCodePage(void);
__declspec(dllexport) unsigned  Scintilla_GetWindowDPI(void* hwnd);
__declspec(dllexport) int       Scintilla_GetSystemMetricsForDpi(int nIndex, unsigned dpi);
__declspec(dllexport) int       Scintilla_AdjustWindowRectForDpi(LPWRECT lpRect, unsigned long dwStyle, unsigned long dwExStyle, unsigned dpi);
// <<<<<<<<<<<<<<<<   END NON STD SCI PATCH   <<<<<<<<<<<<<<<<
```

**Purpose:** Required for NP3's DPI-aware window handling and DLL binding.

### Patch 2: C++ Header Include (Lines 37-41)

**Changed:**
```c
// Upstream:
#include <stdint.h>

// NP3:
#if defined(__cplusplus)
#include <cstdint>
#else
#include <stdint.h>
#endif
```

### Patch 3: User-Defined Message Range (Line 60)

**Added:**
```c
#define SCI_DEV_USER_DEFINED 6000
```

### Patch 4: IME Detection Functions (Lines 128-129)

**Added:**
```c
#define SCI_ISIMEOPEN 6003
#define SCI_ISIMEMODECJK 6004
```

### Patch 5: Strikethrough Style (Lines 270, 283)

**Added:**
```c
#define SCI_STYLESETSTRIKE 6001
#define SCI_STYLEGETSTRIKE 6002
```

### Patch 6: Regex Flag for Dot Match All (Line 540)

**Added:**
```c
#define SCFIND_DOT_MATCH_ALL 0x1000
```

### Patch 7: Keyword Set Maximum (Autogenerated area)

**Changed:**
```c
// Upstream:
#define KEYWORDSET_MAX 8

// NP3:
#define KEYWORDSET_MAX 15
```

---

### Merge Strategy for Future Upgrades

1. **Start with upstream Scintilla.h**
2. **Apply NP3 patches in order:**
   - Add DLL export block after `#ifndef SCINTILLA_H`
   - Update C++ header include
   - Add `SCI_DEV_USER_DEFINED`
   - Add IME detection defines
   - Add strikethrough style defines
   - Add `SCFIND_DOT_MATCH_ALL`
   - Change `KEYWORDSET_MAX` from 8 to 15
3. **Verify ScintillaWin.cxx has matching implementations**

---

## Upgrade Steps

### Phase 1: Lexilla (CAREFUL - Has Customizations)

```
[ ] 1. Download Lexilla 5.4.6 from scintilla.org
[ ] 2. Backup ENTIRE lexilla/ folder
[ ] 3. DO NOT REPLACE these (must preserve):
      - lexilla/lexers_x/ (entire folder - 24 custom files!)
      - lexilla/*.vcxproj (project files reference lexers_x)
      - lexilla/*.vcxproj.filters
[ ] 4. CAREFULLY update these folders:
      - lexilla/src/ (core library)
      - lexilla/include/ (headers)
      - lexilla/lexlib/ (lexer utilities)
[ ] 5. DIFF CHECK lexilla/lexers/ against upstream:
      - Some lexers may have NP3-specific patches
      - Compare with orig/ backups in lexers_x/
[ ] 6. Rebuild and test all syntax highlighting
```

### Phase 2: Scintilla (Moderate)

```
[ ] 1. Download Scintilla 5.5.8 from scintilla.org
[ ] 2. Backup current scintilla/ folder
[ ] 3. DO NOT replace these (preserve NP3 customizations):
      - scintilla/oniguruma/ (entire folder)
      - scintilla/*.vcxproj (project files)
      - scintilla/*.vcxproj.filters
[ ] 4. Replace these folders:
      - scintilla/src/
      - scintilla/include/
      - scintilla/win32/
      - scintilla/doc/
      - scintilla/scripts/
[ ] 5. Check for API changes in:
      - include/Scintilla.h
      - include/ILexer.h
      - src/Document.h
[ ] 6. Update OnigurumaRegExEngine.cxx if needed (API changes)
[ ] 7. Rebuild and test
```

### Phase 3: Testing

```
[ ] 1. Build Debug x64
[ ] 2. Build Release x64
[ ] 3. Build Release Win32
[ ] 4. Test basic editing
[ ] 5. Test regex search/replace
[ ] 6. Test syntax highlighting (multiple languages)
[ ] 7. Test find in files (grepWinNP3)
[ ] 8. Run automated tests
```

---

## Risk Assessment

| Risk | Likelihood | Mitigation |
|------|------------|------------|
| Regex API changes | Low | Check Document.h for RegexSearchBase changes |
| Lexer API changes | Low | Check ILexer.h interface |
| Build errors | Medium | Keep backups, incremental updates |
| Runtime bugs | Low | Thorough testing before release |

---

## Resources

- Scintilla: https://scintilla.org/
- Lexilla: https://scintilla.org/Lexilla.html
- Release History: https://scintilla.org/ScintillaHistory.html
- Oniguruma: https://github.com/kkos/oniguruma

---

## Notes

The main complexity is preserving the **Oniguruma regex integration**:
- Author: RaiKoHoff
- Location: `scintilla/oniguruma/scintilla/OnigurumaRegExEngine.cxx`
- Purpose: Unicode-aware regex with extended syntax
- Activated via `SCI_OWNREGEX` preprocessor define

---

## Custom Patches Management

### Patch Folder Structure

All NP3-specific patches should be stored in `scintilla/np3_patches/` for tracking:

```
scintilla/
‚îú‚îÄ‚îÄ np3_patches/                    # NEW: Track all NP3 customizations
‚îÇ   ‚îú‚îÄ‚îÄ README.md                   # Index of all patches
‚îÇ   ‚îú‚îÄ‚îÄ 001_scintilla_h_exports.patch
‚îÇ   ‚îú‚îÄ‚îÄ 002_directwrite_font_fix.patch
‚îÇ   ‚îî‚îÄ‚îÄ orig/                       # Original upstream files for diffing
‚îÇ       ‚îî‚îÄ‚îÄ ScintillaWin.cxx.orig
‚îú‚îÄ‚îÄ include/
‚îÇ   ‚îî‚îÄ‚îÄ Scintilla.h                 # Contains NP3 exports patch
‚îú‚îÄ‚îÄ win32/
‚îÇ   ‚îî‚îÄ‚îÄ ScintillaWin.cxx            # May contain DirectWrite fix
‚îî‚îÄ‚îÄ oniguruma/                      # Existing - regex engine
```

### Patch Registry

| ID | Patch Name | Files Modified | Scintilla Bug | Status |
|----|------------|----------------|---------------|--------|
| 001 | DLL Export Functions | `include/Scintilla.h` | N/A (NP3-specific) | ‚úÖ Applied |
| 002 | C++ Header Include | `include/Scintilla.h` | N/A | ‚úÖ Applied |
| 003 | User-Defined Messages | `include/Scintilla.h` | N/A | ‚úÖ Applied |
| 004 | IME Detection | `include/Scintilla.h` | N/A | ‚úÖ Applied |
| 005 | Strikethrough Style | `include/Scintilla.h` | N/A | ‚úÖ Applied |
| 006 | SCFIND_DOT_MATCH_ALL | `include/Scintilla.h` | N/A | ‚úÖ Applied |
| 007 | KEYWORDSET_MAX=15 | `include/Scintilla.h` | N/A | ‚úÖ Applied |
| 008 | DirectWrite Font Fix | `win32/ScintillaWin.cxx`, `win32/PlatWin.cxx` | #2080, #2262 | ‚è≥ Pending |

### Upstream Scintilla Bugs (Pending Fixes)

| Bug # | Title | MR | Impact |
|-------|-------|-------|--------|
| **#2080** | D2D font family/face name confusion | [MR #36](https://sourceforge.net/p/scintilla/code/merge-requests/36/) | Variable fonts fail |
| **#2262** | Inability to display some fonts | Related to #2080 | Non-regular styles fail |
| **#2356** | Font weight issues | Related to #2080 | Light/SemiBold fail |

**NP3 Issues Waiting on Fix:** #4150, #5455

---

## Future Upgrade Checklist

When upgrading Scintilla/Lexilla:

### Pre-Upgrade
```
[ ] 1. Create backup of entire scintilla/ and lexilla/ folders
[ ] 2. Note current version numbers in version.txt
[ ] 3. Check Scintilla release notes for breaking changes
[ ] 4. Check if upstream bugs #2080/#2262 are fixed in new version
```

### During Upgrade
```
[ ] 1. Download new Scintilla/Lexilla
[ ] 2. Replace src/, win32/, doc/, scripts/ (NOT include/)
[ ] 3. PRESERVE these folders:
       - scintilla/oniguruma/ (entire folder)
       - scintilla/np3_patches/ (if exists)
       - scintilla/*.vcxproj
       - lexilla/lexers_x/
       - lexilla/*.vcxproj
[ ] 4. Merge Scintilla.h patches manually:
       - Compare new include/Scintilla.h with backup
       - Re-apply patches 001-007 from Patch Registry
[ ] 5. Re-apply Patch 008 (DirectWrite) if not yet in upstream
[ ] 6. Update version.txt
```

### Post-Upgrade Verification
```
[ ] 1. Build Debug x64
[ ] 2. Build Release x64
[ ] 3. Test: Basic text editing
[ ] 4. Test: Regex search/replace (Oniguruma)
[ ] 5. Test: Font selection (try Cascadia Mono Light)
[ ] 6. Test: Variable fonts (try Iosevka)
[ ] 7. Test: DPI scaling (100%, 150%, 200%)
[ ] 8. Test: Syntax highlighting
[ ] 9. Commit with message: "deps: Upgrade Scintilla X.Y.Z, Lexilla A.B.C"
```

### If Upstream Fixes Our Bugs

When Scintilla merges #2080/#2262 fix:
```
[ ] 1. Remove Patch 008 from np3_patches/
[ ] 2. Update Patch Registry (mark as "Upstreamed")
[ ] 3. Close NP3 issues #4150, #5455
[ ] 4. Test font selection thoroughly
```

